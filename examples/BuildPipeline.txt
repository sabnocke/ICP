name BuildPipeline
# Simulation of a CI/CD pipeline: fetch, build, test, deploy, report, with a revert cycle on error.
Input: commit, test_result, deploy_approval
Output: status

Variables:
    int timeout       = 8000      # maximum duration for the fetch/build/test/deploy phase
    bool tests_passed = false
    string last_commit = ""
States:
    state IDLE {
        action {
            output("status", "IDLE: waiting for commit");
        }
    }
    state FETCH {
        action {
            last_commit = valueOf("commit");
            output("status", "FETCHED:" + last_commit);
        }
    }
    state BUILD {
        action {
            output("status", "BUILDING:" + last_commit);
        }
    }
    state TEST {
        action {
            output("status", "TESTING:" + last_commit);
        }
    }
    state DEPLOY {
        action {
            output("status", "DEPLOYING:" + last_commit);
        }
    }
    state REPORT {
        action {
            if (tests_passed) {
                output("status", "SUCCESS:" + last_commit);
            } else {
                output("status", "FAIL:" + last_commit);
            }
        }
    }
Transitions:
    IDLE   --> FETCH    : commit

    FETCH  --> BUILD    : @ timeout
    BUILD  --> TEST     : @ timeout
    TEST   --> DEPLOY   : @ timeout

    TEST   --> REPORT   : test_result [ valueOf("test_result") == "pass" ]
    TEST   --> REPORT   : test_result [ valueOf("test_result") != "pass" ]

    DEPLOY --> REPORT   : deploy_approval [ valueOf("deploy_approval") == "yes" ]
    DEPLOY --> REPORT   : @ timeout

    REPORT --> IDLE     : @ 5000
